---
title: RabbitMQ 消息队列
date: 2018-10-22 00:00:00
tags: [note, linux]
categories: web开发
---

MQ全称为Message Queue, 消息队列（MQ）是一种应用程序对应用程序的通信方法。应用程序通过读写出入队列的消息（针对应用程序的数据）来通信，而无需专用连接来链接它们。

<!-- more -->

## 概念

需要了解一个协议：AMQP协议，协议的流程由消息发布者，交换机，队列，到消息订阅者。交换机做路由分发，将收到的消息根据路由规则分发给绑定的队列。

1. 消息：消息实际包含两部分内容，1是有效载荷，就是要传输的数据，数据类型可以是纯文本或JSON。2是标签，它包含交换机的名字和可选的主题(topic)标记等，AMQP仅仅描述了标签，而RabbitMQ决定了把这个消息发给哪个消费者。

2. 发布者：也就是生产者，创建消息并设置标签

3. 消费者：消费者连接到代理服务器上，接受有效载荷，消费者不需要消息中的标签

消息投递失败会重发，保证消息正确取出和执行，AMQP模块包含了消息确认的概念，在收到消费者的确认回执前，消息代理不会将消息从队列中删除。

## 交换机

交换机拿到消息后，将路由给队列，使用哪种路由算法是由交换机类型和被称作“绑定（queue_bind）”的规则决定的。

可配置的队列如下：

1. 直连交换机（direct exchange）

根据消息携带的`路由键(routing key)`将消息投递给对应的队列。将一个队列绑定到某个交换机的同时赋予该绑定一个路由键，当一个携带者路由键为XXX的消息被发送给直连交换机时，交换机会把它路由给绑定值同样为XXX的队列。直连交换机用来处理消息的单播路由。

2. 主题交换机（topic exchange）

通过对消息的`路由键`和队列到交换机的`绑定模式`之间的匹配，将消息路由给一个或多个队列。主题交换机通常用来实现消息的`多播路由`。发送到主题交换机的消息的路由键，必须是一个由 “.” 分隔的词语列表，这些词语应该和对应的业务关联，词语的个数可以随意，但是不要超过255字节。绑定键支持通配符：“*” 用来表示一个单词；“#” 用来表示任意数量(零个或多个)单词。

3. 扇形交换机（fanout exchange）

将消息路由给绑定到它身上的所有队列，且不理会绑定的路由键。用来做消息的`广播路由`。它允许你对单条消息做不同的处理，在开发中一个操作可能要多个连带工作，比如用户创建一篇新的日记，需要更新用户的创建日记数，清除相关缓存，给关注这个用户的其他用户推消息，日记进审核后台，日记进最新日记池等等。可以使用扇形交换机把一个消息分发给多个任务队列，执行不一样的工作。尤其是业务改变时，使用扇形交换机`直接为新的消费者添加声明`，并绑定进来就可以了，否则需要修改发送方的代码来添加接收方。所以，使用扇形交换机可以有效地`解耦`发送者和消费者。

4. 头交换机（headers exchange）

允许匹配AMQP的头而非路由键，其实使用起来和直接交换机差不多，但是性能却差很多，一般用不到这种类型。

## 虚拟主机

通过创建新的虚拟主机，实现隔离，不同的虚拟主机直接完全隔离，拥有自己的队列，绑定和交换机。就像创建了一个新用户，服务A做订单的，链接对应的虚拟主机，服务B做消息推送的，链接对应的虚拟主机。默认是虚拟主机是 `/`，使用guest做默认用户和密码，通过命令创建新的虚拟主机：

```sh
sudo rabbitmqctl add_user dongwm 123456
sudo rabbitmqctl add_vhost web_develop
sudo rabbitmqctl set_permissions -p web_develop dongwm ".*" ".*" ".*"
```

`rabbitmqctl set_permissions` 是配置权限，三个对应的权限是：配置（队列和交换的创建和删除）、写（发布消息）、读（消费消息）的权限。

## 常用命令

- sudo rabbitmqctl list_vhosts
- sudo rabbitmqctl list_queue -p web_develop
- sudo rabbitmqctl list_users